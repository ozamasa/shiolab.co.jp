---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  fetchAllArticles,
  fetchArticleById,
  normalizeCategories,
} from "../../lib/microcms";

// 静的生成
export async function getStaticPaths() {
  const all = await fetchAllArticles();
  return all.map((a) => ({
    params: { id: a.id },
  }));
}

const { id } = Astro.params;
const article = await fetchArticleById(String(id));

// 安全ガード
const title = article?.title ?? "記事が見つかりません";
const description = article?.description ?? "";
const dateText =
  article?.date ?? article?.publishedAt ?? article?.createdAt ?? "";

// 本文は body を優先（content もフォールバックとして扱う）
const bodyHtml = ((article as any)?.body ?? (article as any)?.content ?? "") as string;

// カテゴリは複数あり得る
const categories = normalizeCategories((article as any)?.category);
---

<BaseLayout
  title={title}
  description={description || "SHIOLABの記事ページです。"}
>
  {!article ? (
    <section class="card">
      <h1>記事が見つかりません</h1>
      <p>URLが間違っているか、記事が非公開になっている可能性があります。</p>
      <p><a href="/articles/">記事一覧へ戻る →</a></p>
    </section>
  ) : (
    <>
      <!-- 記事ヘッダー -->
      <article class="card">
        <div class="meta" style="margin-bottom:10px;">
          {categories.length > 0 ? (
            <>
              {categories.map((c) => (
                <a
                  class="pill"
                  href={`/category/${c.slug}/`}
                  style="text-decoration:none;"
                >
                  {c.label}
                </a>
              ))}
            </>
          ) : (
            <span class="pill">カテゴリ未設定</span>
          )}

          {dateText && (
            <span class="pill">
              更新 {dateText.toString().slice(0, 10)}
            </span>
          )}
        </div>

        <h1 style="margin:0 0 16px; line-height:1.4;">
          {title}
        </h1>

        {description && (
          <p style="font-size:16px; color:#334155; line-height:1.8;">
            {description}
          </p>
        )}
      </article>

      <!-- 本文（microCMS: body / content のHTMLを表示） -->
      <section class="card" style="margin-top:14px;">
        {bodyHtml?.trim()?.length ? (
          <div class="articleBody" set:html={bodyHtml} />
        ) : (
          <p style="margin:0; line-height:1.8;" class="muted">
            この記事は本文が未入力です（microCMS の <code>body</code> または <code>content</code> を確認してください）。
          </p>
        )}
      </section>

      <!-- ナビ -->
      <section class="card" style="margin-top:14px;">
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <a href="/articles/">← 記事一覧へ</a>
          <a href="/">トップへ</a>
          <a href="/quiz/">クイズで練習 →</a>
        </div>
      </section>
    </>
  )}
</BaseLayout>