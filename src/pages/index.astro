---
import BaseLayout from "../layouts/BaseLayout.astro";
import ArticleCard from "../components/ArticleCard.astro";
import { fetchAllArticles, normalizeCategories } from "../lib/microcms";

const all = await fetchAllArticles();

// 公開記事だけ（microCMS側で下書き除外はされる想定。念のため空タイトルは除外）
const articles = (all || []).filter((a) => (a.title ?? "").toString().trim().length > 0);

// 日付ソート（date優先、なければpublishedAt）
articles.sort((a, b) => {
  const da = new Date((a.date || a.publishedAt || a.createdAt || 0) as any).getTime();
  const db = new Date((b.date || b.publishedAt || b.createdAt || 0) as any).getTime();
  return db - da;
});

// 最新
const latest = articles.slice(0, 8);

// カテゴリ集計（slugで重複排除、記事数も出す）
type CatAgg = { slug: string; label: string; count: number };
const catMap = new Map<string, CatAgg>();

for (const a of articles) {
  const cats = normalizeCategories((a as any).category);
  for (const c of cats) {
    const key = c.slug; // すでにencode済み想定
    const cur = catMap.get(key);
    if (cur) cur.count += 1;
    else catMap.set(key, { slug: key, label: c.label, count: 1 });
  }
}

// 件数が多い順（同数ならラベル順）
const categories = Array.from(catMap.values()).sort((x, y) => {
  if (y.count !== x.count) return y.count - x.count;
  return x.label.localeCompare(y.label, "ja");
}).slice(0, 8);
---
<BaseLayout
  title="SHIOLAB｜資格・受験・学習の攻略メディア"
  description="SHIOLABは、資格・受験・学校学習などの“4択試験攻略パターン”を、記事とクイズで学べる学習メディアです。"
>
  <section class="card hero">
    <div class="heroGrid">
      <div>
        <div class="heroKicker">4択試験の「選択肢を切る」技術</div>
        <h1>迷わないための攻略パターン</h1>
        <p>
          SHIOLAB は、資格試験・受験・学校学習の4択問題を、
          <span style="font-weight:800;">「なぜこの選択肢は切れるのか」</span>の視点で整理した学習メディアです。
        </p>

        <div class="btnRow">
          <a class="btn" href="#categories">カテゴリから探す</a>
          <a class="btn sub" href="/articles/">記事一覧を見る</a>
          <a class="btn" href="https://quiz.shiolab.co.jp/" target="_blank" rel="noopener">クイズで練習</a>
        </div>
      </div>

      <aside class="heroAside">
        <h3>まずはこの型だけ</h3>
        <ul>
          <li>主語・時制・品詞を先に見る</li>
          <li>切れる選択肢を先に消す</li>
          <li>最後に意味で確認してミス防止</li>
        </ul>
      </aside>
    </div>
  </section>

  <!-- カテゴリ -->
  <div class="sectionHead" id="categories">
    <h2>カテゴリから探す</h2>
    <a href="/categories/">すべてのカテゴリ →</a>
  </div>

    {categories.length === 0 ? (
      <section class="card">
        <p style="margin:0;">記事にカテゴリが付いていないため、カテゴリ一覧はまだ表示されません。</p>
      </section>
    ) : (
      <section class="card" style="margin-top:12px;">
        <div class="chipRow">
          {categories.map((c) => (
            <a class="chip" href={`/category/${c.slug}/`}>
              <span>{c.label}</span>
              <small>{c.count}件</small>
            </a>
          ))}
        </div>
      </section>
    )}

  <!-- 最新記事 -->
  <div class="sectionHead" style="margin-top:34px;">
    <h2>最新記事</h2>
    <a href="/articles/">記事一覧 →</a>
  </div>

    {latest.length === 0 ? (
      <section class="card">
        <p style="margin:0;">まだ記事がありません。microCMSに記事を追加するとここに表示されます。</p>
      </section>
    ) : (
      <section class="card" style="margin-top:12px;">
        <section class="grid" style="margin-top:0;">
          {latest.slice(0, 6).map((a) => (
            <ArticleCard item={a} />
          ))}
        </section>
      </section>
    )}
</BaseLayout>
