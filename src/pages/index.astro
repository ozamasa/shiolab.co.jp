---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategories } from "../lib/microcms";
import { normalizeCategories } from "../lib/microcms";

const articles = await fetchAllArticles();

// 新しい順（date > publishedAt > createdAt）
articles.sort((a, b) => {
  const ad = new Date(a.date || a.publishedAt || a.createdAt || 0).getTime();
  const bd = new Date(b.date || b.publishedAt || b.createdAt || 0).getTime();
  return bd - ad;
});

const latest = articles.slice(0, 4);

// カテゴリ抽出（複数カテゴリ対応） + 件数
const catCount = new Map<string, { label: string; slug: string; count: number }>();

for (const a of articles) {
  const cats = normalizeCategories(a.category);
  for (const c of cats) {
    const prev = catCount.get(c.slug);
    if (!prev) catCount.set(c.slug, { ...c, count: 1 });
    else catCount.set(c.slug, { ...prev, count: prev.count + 1 });
  }
}

const categories = [...catCount.values()].sort((x, y) => y.count - x.count).slice(0, 8);
---
<BaseLayout
  title="LOGICLAB｜4択試験の攻略パターン集"
  description="資格試験・受験・学校学習の4択問題を、「なぜこの選択肢は切れるのか」の視点で整理した学習メディア。"
>
  <section class="hero">
    <div class="heroInner">
      <p class="kicker">4択試験の「切り方」を学ぶ</p>
      <h1>LOGICLAB</h1>
      <p class="lead">
        資格試験・受験・学校学習の4択問題を、「なぜこの選択肢は切れるのか」という視点で整理します。
      </p>
      <p class="lead">
        正解を覚えるのではなく、消去の思考プロセスを身につけるための学習サイトです。
      </p>
      <div class="heroCta">
        <a class="btn btnPrimary" href="/articles/">攻略パターンを読む</a>
        <a class="btn" href="/quiz/">クイズで確認する</a>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="sectionHeader">
      <div>
        <h2>カテゴリから探す</h2>
        <p>まずは分野を選んで、近いテーマから入れます。</p>
      </div>
      <a class="btn btnSmall" href="/articles/">記事一覧へ</a>
    </div>

    {categories.length === 0 ? (
      <section class="card">
        <p>まだカテゴリがありません。記事を追加するとここに表示されます。</p>
      </section>
    ) : (
      <section class="grid">
        {categories.map((c) => (
          <article class="card">
            <div class="catTop">
              <h3 class="catTitle">
                <a class="cardLink" href={`/category/${c.slug}/`}>{c.label}</a>
              </h3>
              <span class="pill">{c.count} 記事</span>
            </div>
            <p class="muted" style="margin:6px 0 14px;">
              {c.label} の攻略パターンをまとめています。
            </p>
            <a class="btn btnSmall" href={`/category/${c.slug}/`}>このカテゴリを見る</a>
          </article>
        ))}
      </section>
    )}
  </section>

  <section class="section">
    <div class="sectionHeader">
      <div>
        <h2>最新記事</h2>
        <p>最近追加された攻略パターン</p>
      </div>
      <a class="btn btnSmall" href="/articles/">すべての記事</a>
    </div>

    {latest.length === 0 ? (
      <section class="card">
        <p>まだ記事がありません。最初の記事を追加するとここに表示されます。</p>
      </section>
    ) : (
      <section class="grid">
        {latest.map((a) => (
          <article class="card">
            <h3 style="margin:0 0 10px;">
              <a class="cardLink" href={`/articles/${a.id}/`}>{a.title}</a>
            </h3>
            {a.description ? (
              <p class="muted" style="margin:0 0 14px; line-height:1.8;">
                {a.description}
              </p>
            ) : null}

            <div class="metaRow" style="margin-top:0;">
              {a.category ? (
                <span class="metaItem">
                  カテゴリ：
                  {normalizeCategories(a.category).map((c) => (
                    <a href={`/category/${c.slug}/`} class="tag">
                      {c.label}
                    </a>
                  ))}
                </span>
              ) : (
                <span class="metaItem">カテゴリ：未設定</span>
              )}
              {a.dateText ? <span class="metaItem">更新：{a.dateText.slice(0, 10)}</span> : null}
            </div>

            <div style="margin-top:14px;">
              <a class="btn btnSmall" href={`/articles/${a.id}/`}>続きを読む</a>
            </div>
          </article>
        ))}
      </section>
    )}
  </section>

  <section class="section">
    <div class="sectionHeader">
      <div>
        <h2>使い方</h2>
        <p>最短で「切り方」を身につける流れ</p>
      </div>
      <a class="btn btnSmall" href="/guide/">使い方を見る</a>
    </div>

    <section class="card">
      <ol class="steps">
        <li>カテゴリから、近いテーマを選ぶ</li>
        <li>「切れる理由」を読んで、型をつかむ</li>
        <li>クイズで確認して、定着させる</li>
      </ol>
    </section>
  </section>
</BaseLayout>
