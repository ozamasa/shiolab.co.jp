---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategory } from "../lib/microcms";

const all = await fetchAllArticles();

// 公開記事だけ（microCMS側で下書き除外はされる想定。念のため空タイトルは除外）
const articles = (all || []).filter((a) => (a.title ?? "").toString().trim().length > 0);

// 日付ソート（date優先、なければpublishedAt）
articles.sort((a, b) => {
  const da = new Date((a.date || a.publishedAt || a.createdAt || 0) as any).getTime();
  const db = new Date((b.date || b.publishedAt || b.createdAt || 0) as any).getTime();
  return db - da;
});

// 最新
const latest = articles.slice(0, 8);

// カテゴリ集計（slugで重複排除、記事数も出す）
type CatAgg = { slug: string; label: string; count: number };
const catMap = new Map<string, CatAgg>();

for (const a of articles) {
  const c = normalizeCategory(a.category);
  if (!c) continue;

  const key = c.slug; // すでにencode済み想定
  const cur = catMap.get(key);
  if (cur) cur.count += 1;
  else catMap.set(key, { slug: key, label: c.label, count: 1 });
}

// 件数が多い順（同数ならラベル順）
const categories = Array.from(catMap.values()).sort((x, y) => {
  if (y.count !== x.count) return y.count - x.count;
  return x.label.localeCompare(y.label, "ja");
}).slice(0, 8);
---

<BaseLayout
  title="SHIOLAB｜資格・受験・学習の攻略パターン"
  description="SHIOLABは、4択試験で「なぜその選択肢を切れるのか」を短く整理した攻略パターン記事と確認クイズを提供します。"
>
  <style>
    .hero{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      align-items: start;
    }
    @media (min-width: 900px){
      .hero{ grid-template-columns: 1.4fr .6fr; }
    }
    .heroTitle{
      font-size: 30px;
      margin: 0 0 10px;
      line-height: 1.25;
    }
    .heroLead{
      margin:0;
      font-size: 15px;
    }
    .ctaRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 800;
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      color: var(--text);
      text-decoration:none;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff;
      border-color: transparent;
    }
    .btn:hover{ text-decoration:none; }

    .kpi{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    .kpiBox{
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 12px;
      background: color-mix(in srgb, var(--surface) 90%, transparent);
    }
    .kpiNum{
      font-weight: 900;
      font-size: 18px;
      margin: 0;
      color: var(--text);
    }
    .kpiLabel{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .sectionHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-top: 32px;
    }
    .sectionHead h2{ margin:0; }
    .sectionHead a{ font-size: 13px; color: var(--muted); }

    .metaLine{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface) 88%, transparent);
      font-size: 12px;
      color: var(--muted);
      text-decoration:none;
    }
  </style>

  <!-- HERO -->
  <section class="hero">
    <section class="card">
      <h1 class="heroTitle">4択試験は「解く」より「切る」</h1>
      <p class="heroLead">
        SHIOLAB は、資格・受験・学校学習などの4択問題で
        <span style="color:var(--text); font-weight:800;">「なぜこの選択肢は即切りできるのか」</span>
        を短い手順にしてまとめる学習メディアです。
        記事で型を覚え、クイズで確認します。
      </p>

      <div class="ctaRow">
        <a class="btn primary" href="/articles/">攻略記事を読む</a>
        <a class="btn" href="/quiz/">クイズで確認する</a>
        <a class="btn" href="/guide/">使い方を見る</a>
      </div>

      <div class="metaLine">
        <span>・記事：{articles.length}本</span>
        <span>・カテゴリ：{catMap.size}件</span>
        <span>・更新は随時</span>
      </div>
    </section>

    <aside class="card">
      <h2 style="margin:0 0 10px; font-size:16px;">まずはこの順で</h2>
      <ol style="margin:0; padding-left:18px; color:var(--muted); line-height:1.9;">
        <li>記事で「切り方の型」を1つ覚える</li>
        <li>同じ型のクイズで5問だけ確認</li>
        <li>間違えた選択肢の“切れない理由”をメモ</li>
      </ol>

      <div style="height:12px;"></div>

      <div class="kpi">
        <div class="kpiBox">
          <p class="kpiNum">{latest.length}</p>
          <p class="kpiLabel">最新記事（表示中）</p>
        </div>
        <div class="kpiBox">
          <p class="kpiNum">{categories.length}</p>
          <p class="kpiLabel">人気カテゴリ（表示中）</p>
        </div>
      </div>
    </aside>
  </section>

  <!-- 最新記事 -->
  <div class="sectionHead">
    <h2>最新記事</h2>
    <a href="/articles/">記事一覧へ →</a>
  </div>

  {latest.length === 0 ? (
    <section class="card" style="margin-top:14px;">
      <p style="margin:0;">
        まだ記事がありません。microCMSに記事を追加するとここに表示されます。
      </p>
    </section>
  ) : (
    <section class="grid" style="margin-top:14px;">
      {latest.map((a) => {
        const cat = normalizeCategory(a.category);
        const dateText = (a.date || a.publishedAt || a.createdAt || "").toString().slice(0, 10);
        return (
          <article class="card">
            <h3 style="margin:0 0 8px; font-size:18px;">
              <a href={`/articles/${a.id}/`}>{a.title}</a>
            </h3>

            {a.description ? (
              <p style="margin:0; color:var(--muted); font-size:14px; line-height:1.75;">
                {a.description}
              </p>
            ) : null}

            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
              {cat ? <a class="pill" href={`/category/${cat.slug}/`}>カテゴリ：{cat.label}</a> : <span class="pill">カテゴリ：未設定</span>}
              {dateText ? <span class="pill">更新：{dateText}</span> : null}
            </div>
          </article>
        );
      })}
    </section>
  )}

  <!-- カテゴリ -->
  <div class="sectionHead">
    <h2>カテゴリ</h2>
    <a href="/articles/">全部見る →</a>
  </div>

  {categories.length === 0 ? (
    <section class="card" style="margin-top:14px;">
      <p style="margin:0;">
        まだカテゴリがありません。記事にカテゴリを付けると表示されます。
      </p>
    </section>
  ) : (
    <section class="grid" style="margin-top:14px;">
      {categories.map((c) => (
        <article class="card">
          <h3 style="margin:0 0 8px; font-size:16px;">{c.label}</h3>
          <p style="margin:0; font-size:14px; color:var(--muted);">
            {c.count}本の攻略記事があります。
          </p>
          <div style="margin-top:12px;">
            <a class="btn" href={`/category/${c.slug}/`}>このカテゴリを見る →</a>
          </div>
        </article>
      ))}
    </section>
  )}

  <!-- 下段導線 -->
  <section class="card" style="margin-top:28px;">
    <h2 style="margin:0 0 10px;">学習を進める</h2>
    <p style="margin:0 0 12px;">
      目的に合わせて入口を選べます。
    </p>
    <div class="ctaRow">
      <a class="btn primary" href="/articles/">攻略パターンを読む</a>
      <a class="btn" href="/quiz/">確認クイズへ</a>
      <a class="btn" href="/contact/">お問い合わせ</a>
    </div>
  </section>
</BaseLayout>