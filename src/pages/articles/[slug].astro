---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { getAllArticles } from "../../lib/articles";

export async function getStaticPaths() {
  const all = await getAllArticles();
  return all.map((a) => ({ params: { slug: a.slug } }));
}

const { slug } = Astro.params;

const local = (await getCollection("articles")).find((e) => e.slug === slug);

let title = "";
let description = "";
let tags: string[] = [];
let levels: string[] = [];
let quizUrl = "";
let updatedAt = "";
let bodyHtml = "";

if (local) {
  title = local.data.title;
  description = local.data.description || "";
  tags = local.data.tags || [];
  levels = local.data.levels || [];
  quizUrl = local.data.quizUrl || "";
  updatedAt = local.data.updatedAt || "";
  const rendered = await local.render();
  bodyHtml = rendered.html;
} else {
  const all = await getAllArticles();
  const hit = all.find((a) => a.slug === slug);
  if (hit) {
    title = hit.title;
    description = hit.description || "";
    tags = hit.tags || [];
    levels = hit.levels || [];
    quizUrl = hit.quizUrl || "";
    updatedAt = hit.updatedAt || "";
    bodyHtml = hit.bodyHtml || "<p>本文がありません。</p>";
  }
}

const pageTitle = `${title}｜SHIOLAB`;
---
<BaseLayout title={pageTitle} description={description} canonical={`https://shiolab.co.jp/articles/${slug}/`}>
  <article class="card">
    <div class="muted" style="font-size:12px;">
      {updatedAt ? `更新: ${updatedAt}` : ""}
    </div>
    <h1 class="h1" style="font-size:24px; margin-top:6px;">{title}</h1>
    {description ? <p class="p">{description}</p> : null}

    <div class="badges">
      {tags.map((t) => <span class="badge">{t}</span>)}
      {levels.map((l) => <span class="badge">{l}</span>)}
    </div>

    <div class="hr"></div>

    <div class="articleBody" set:html={bodyHtml} />

    <div class="hr"></div>

    <section aria-label="練習へ進む">
      <p class="p" style="margin:0 0 10px;">
        同じ型は、短時間で何回か解くと定着します。
      </p>
      <div class="btnRow">
        <a class="btn" href={quizUrl || "https://quiz.shiolab.co.jp/"} target="_blank" rel="noopener">
          この型をクイズで練習
        </a>
        <a class="btn sub" href="/articles/">記事一覧へ戻る</a>
      </div>
    </section>
  </article>
</BaseLayout>
