---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategory } from "../../lib/microcms";

const articles = await fetchAllArticles();

// カテゴリ一覧（slugごとに集計）
const map = new Map<string, { label: string; slug: string; count: number }>();
for (const a of articles) {
  const cats = Array.isArray(a.category) ? a.category : [a.category];
  for (const c of cats) {
    const n = normalizeCategory(c as any);
    if (!n) continue;
    const cur = map.get(n.slug);
    if (!cur) map.set(n.slug, { ...n, count: 1 });
    else cur.count += 1;
  }
}

const categories = Array.from(map.values()).sort((x, y) => y.count - x.count);
---

<BaseLayout
  title="カテゴリ一覧｜SHIOLAB"
  description="SHIOLABのカテゴリ一覧です。資格・受験・学校学習などの攻略パターン記事をカテゴリ別に探せます。"
>
  <section class="card">
    <h1 style="margin:0 0 10px;">カテゴリ一覧</h1>
    <p style="margin:0; color:var(--muted);">
      記事が増えても迷わないように、まずはカテゴリから探せるようにしています。
    </p>
  </section>

  {categories.length === 0 ? (
    <section class="card" style="margin-top:14px;">
      <p style="margin:0;">カテゴリがまだありません。</p>
    </section>
  ) : (
    <section class="chipRow" style="margin-top:14px;">
      {categories.map((c) => (
        <a class="chip" href={`/category/${c.slug}/`}>
          <span>{c.label}</span>
          <small>{c.count}件</small>
        </a>
      ))}
    </section>
  )}

  <section class="card" style="margin-top:14px;">
    <p style="margin:0;">
      <a href="/">← トップへ戻る</a>
    </p>
  </section>
</BaseLayout>
