---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { fetchAllArticles, fetchArticleById, normalizeCategories } from "../../lib/microcms";

export async function getStaticPaths() {
  const all = await fetchAllArticles();
  return all.map((a) => ({ params: { id: a.id } }));
}

const { id } = Astro.params;
const article = await fetchArticleById(String(id));

const title = (article?.title ?? "記事が見つかりません").toString();
const description = (article?.description ?? "").toString();

// content は使わない方針：microCMS 側の body（リッチテキストHTML想定）を優先
const bodyHtml = (article?.body ?? "").toString();

// 日付はあるものを優先表示
const dateText = (article?.date ?? article?.publishedAt ?? article?.updatedAt ?? article?.createdAt ?? "").toString();

// カテゴリ（複数対応）
const cats = normalizeCategories(article?.category);
---

<BaseLayout title={title} description={description || "SHIOLABの記事ページです。"}>
  {!article ? (
    <section class="card">
      <h1 style="margin:0 0 8px;">記事が見つかりません</h1>
      <p style="margin:0 0 12px;">URL が間違っているか、記事が非公開になっている可能性があります。</p>
      <p style="margin:0;">
        <a class="smallLink" href="/articles/">記事一覧へ戻る →</a>
      </p>
    </section>
  ) : (
    <>
      <article class="card">
        <h1 style="margin:0 0 10px;">{title}</h1>

        <div class="metaRow" style="margin-bottom:10px;">
          {cats.length > 0 ? (
            <div class="tagRow">
              <span class="muted">カテゴリ：</span>
              {cats.map((c) => (
                <a class="tag" href={`/category/${c.slug}/`}>{c.label}</a>
              ))}
            </div>
          ) : (
            <span class="muted">カテゴリ：未設定</span>
          )}

          {dateText ? <span class="muted">更新：{dateText.slice(0, 10)}</span> : null}
        </div>

        {description ? <p class="lead" style="margin:0;">{description}</p> : null}
      </article>

      {bodyHtml.trim().length > 0 ? (
        <section class="card" style="margin-top:14px;">
          <div class="prose" set:html={bodyHtml} />
        </section>
      ) : null}

      <section class="card" style="margin-top:14px;">
        <p style="margin:0;">
          <a class="smallLink" href="/articles/">← 記事一覧へ</a>
        </p>
      </section>
    </>
  )}
</BaseLayout>
