---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategories } from "../../lib/microcms";

// 静的生成に必須
export async function getStaticPaths() {
  const articles = await fetchAllArticles();

  const map = new Map<string, string>(); // slug -> label

  for (const article of articles) {
    const cats = normalizeCategories(article.category);
    for (const c of cats) {
      if (!map.has(c.slug)) map.set(c.slug, c.label);
    }
  }

  return Array.from(map.entries()).map(([slug, label]) => ({
    params: { category: slug },
    props: { label },
  }));
}

const { category } = Astro.params;
const { label } = Astro.props;

const articles = await fetchAllArticles();

const filtered = articles
  .filter((article) => normalizeCategories(article.category).some((c) => c.slug === category))
  .sort((a, b) => {
    const ad = new Date(a.date || a.publishedAt || a.createdAt || 0).getTime();
    const bd = new Date(b.date || b.publishedAt || b.createdAt || 0).getTime();
    return bd - ad;
  });
---

<BaseLayout title={`${label} の記事一覧｜SHIOLAB`} description={`${label} に関する攻略パターン記事の一覧です。`}>
  <section class="card">
    <div class="metaRow" style="margin-bottom:10px;">
      <div class="metaTags">
        <span class="metaLabel">カテゴリ</span>
        <span class="tag">{label}</span>
      </div>
    </div>

    <h1 class="pageTitle">{label}</h1>
    <p class="lead">{label} に関する攻略記事一覧です。</p>

    <div class="inlineCta">
      <a class="btn sub" href="/">トップへ</a>
      <a class="btn sub" href="/articles/">記事一覧</a>
    </div>
  </section>

  {filtered.length === 0 ? (
    <section class="card" style="margin-top:20px;">
      <p class="muted" style="margin:0;">まだ記事がありません。</p>
    </section>
  ) : (
    <section class="grid" style="margin-top:20px;">
      {filtered.map((article) => (
        <article class="card cardHover">
          <h2 class="cardTitle">
            <a href={`/articles/${article.id}/`}>{article.title}</a>
          </h2>
          {article.description ? <p class="cardDesc">{article.description}</p> : null}
        </article>
      ))}
    </section>
  )}
</BaseLayout>
