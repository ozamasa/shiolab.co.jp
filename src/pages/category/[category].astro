---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategory } from "../../lib/microcms";

// 静的生成に必須
export async function getStaticPaths() {
  const articles = await fetchAllArticles();

  const categorySet = new Map<string, string>();

  for (const article of articles) {
    const normalized = normalizeCategory(article.category);
    if (!normalized) continue;

    // slug を key, label を value にして重複排除
    if (!categorySet.has(normalized.slug)) {
      categorySet.set(normalized.slug, normalized.label);
    }
  }

  return Array.from(categorySet.entries()).map(([slug, label]) => ({
    params: { category: slug },
    props: { label },
  }));
}

const { category } = Astro.params;
const { label } = Astro.props;

const articles = await fetchAllArticles();

const filtered = articles.filter((article) => {
  const normalized = normalizeCategory(article.category);
  if (!normalized) return false;
  return normalized.slug === category;
});
---

<BaseLayout title={`${label} の記事一覧`}>
  <section class="card">
    <h1>{label}</h1>
    <p>{label} に関する攻略記事一覧です。</p>
  </section>

  {filtered.length === 0 ? (
    <section class="card">
      <p>まだ記事がありません。</p>
    </section>
  ) : (
    <section class="grid" style="margin-top:24px;">
      {filtered.map((article) => (
        <article class="card">
          <h3 style="margin:0 0 8px;">
            <a href={`/articles/${article.id}/`}>
              {article.title}
            </a>
          </h3>

          {article.description ? (
            <p style="font-size:14px; color:#666;">
              {article.description}
            </p>
          ) : null}
        </article>
      ))}
    </section>
  )}
</BaseLayout>