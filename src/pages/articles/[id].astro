---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  fetchAllArticles,
  fetchArticleById,
  normalizeCategories,
  getArticleBodyHtml,
} from "../../lib/microcms";

// 静的生成に必須
export async function getStaticPaths() {
  const all = await fetchAllArticles();
  return all.map((a) => ({
    params: { id: a.id },
  }));
}

const { id } = Astro.params;
const article = await fetchArticleById(String(id));

// microCMS側で null が来ることがあるので全部ガード
const title = (article?.title ?? "記事が見つかりません").toString();
const description = (article?.description ?? "").toString();
const bodyHtml = getArticleBodyHtml(article);
const dateText =
  (article?.date ?? article?.publishedAt ?? article?.createdAt ?? "").toString();

const categories = normalizeCategories(article?.category);
---

<BaseLayout
  title={title}
  description={description || "SHIOLABの記事ページです。"}
>
  {!article ? (
    <section class="card">
      <h1 class="pageTitle">記事が見つかりません</h1>
      <p class="lead">
        URL が間違っているか、記事が非公開になっている可能性があります。
      </p>
      <p class="actions">
        <a class="btn sub" href="/articles/">記事一覧へ戻る</a>
      </p>
    </section>
  ) : (
    <>
      <article class="card">
        <div class="metaRow">
          {categories.length > 0 ? (
            <div class="metaTags">
              <span class="metaLabel">カテゴリ</span>
              {categories.map((c) => (
                <a class="tag" href={`/category/${c.slug}/`}>{c.label}</a>
              ))}
            </div>
          ) : (
            <div class="metaTags">
              <span class="metaLabel">カテゴリ</span>
              <span class="tag muted">未設定</span>
            </div>
          )}

          {dateText ? (
            <div class="metaDate">更新：{dateText.slice(0, 10)}</div>
          ) : null}
        </div>

        <h1 class="pageTitle">{title}</h1>

        {description ? (
          <p class="lead">{description}</p>
        ) : null}

        <div class="inlineCta">
          <a class="btn" href="https://quiz.shiolab.co.jp/" target="_blank" rel="noopener">
            クイズで確認する
          </a>
          <a class="btn sub" href="/articles/">記事一覧</a>
        </div>
      </article>

      <section class="card" style="margin-top:14px;">
        {bodyHtml.trim().length === 0 ? (
          <p class="muted" style="margin:0;">
            この記事は本文が未入力です（microCMS の <code>body</code> を確認してください）。
          </p>
        ) : (
          <div class="prose" set:html={bodyHtml} />
        )}
      </section>

      <section class="card" style="margin-top:14px;">
        <p style="margin:0;">
          <a href="/articles/">← 記事一覧へ</a>
        </p>
      </section>
    </>
  )}
</BaseLayout>
