---
import BaseLayout from "../layouts/BaseLayout.astro";
import { microcms, type Article } from "../lib/microcms";

let latest: Article[] = [];
let categories: string[] = [];
let errorMsg = "";

// microCMSから最新6件
try {
  if (!microcms) throw new Error("microCMSの環境変数が未設定です");

  const res = await microcms.getList<Article>({
    endpoint: "articles",
    queries: {
      limit: 6,
      orders: "-publishedAt",
      fields: "id,title,description,category,publishedAt",
    },
  });

  latest = res.contents ?? [];
  categories = [...new Set(latest.map(a => a.category).filter(Boolean))] as string[];
} catch (e: any) {
  errorMsg = e?.message ?? String(e);
}
---

<BaseLayout
  title="SHIOLAB｜学習を“解ける形”にする"
  description="SHIOLABは、勉強を続けやすい形に整える学習メディアです。選択問題は「選択肢の切り方」から身につけます。"
>
  <section class="card">
    <h1>SHIOLAB</h1>
    <p>
      SHIOLAB は、試験や学習でつまずきやすいポイントを「解ける形」に整理して、
      迷わず練習できるようにする学習メディアです。
    </p>
    <p>
      記事では「この形ならこの選択肢は切れる」という判断のしかたを、具体例つきで解説します。
    </p>
  </section>

  <h2 style="margin-top:32px;">最新記事</h2>

  {errorMsg ? (
    <section class="card">
      <p style="color:#b91c1c; margin:0;">記事の読み込みに失敗しました：{errorMsg}</p>
      <p style="color:#666; margin-top:8px;">
        microCMS の serviceDomain / apiKey と、コンテンツAPI名（articles）を確認してください。
      </p>
    </section>
  ) : latest.length === 0 ? (
    <section class="card">
      <p>まだ記事がありません。</p>
    </section>
  ) : (
    <section class="grid">
      {latest.map((a) => (
        <article class="card">
          <h3 style="margin:0 0 8px;">
            <a href={`/articles/${a.id}/`}>{a.title}</a>
          </h3>
          {a.description ? (
            <p style="font-size:14px; color:#666; margin:0;">{a.description}</p>
          ) : null}
          {a.category ? (
            <p style="font-size:12px; color:#888; margin-top:10px;">
              カテゴリ：{a.category}
            </p>
          ) : null}
        </article>
      ))}
    </section>
  )}

  <h2 style="margin-top:40px;">カテゴリ</h2>
  {categories.length === 0 ? (
    <section class="card">
      <p>カテゴリは記事と一緒に表示されます。</p>
    </section>
  ) : (
    <section class="grid">
      {categories.map((cat) => (
        <article class="card">
          <h3 style="margin:0 0 8px;">{cat}</h3>
          <p style="margin:0 0 10px;">
            {cat} の「選択肢の切り方」をまとめています。
          </p>
          <p style="margin:0;">
            <a href={`/category/${encodeURIComponent(cat)}/`}>一覧を見る →</a>
          </p>
        </article>
      ))}
    </section>
  )}
</BaseLayout>