---
import BaseLayout from "../layouts/BaseLayout.astro";
import ArticleCard from "../components/ArticleCard.astro";
import { fetchAllArticles, normalizeCategories } from "../lib/microcms";

const all = await fetchAllArticles();

// 公開記事だけ（microCMS側で下書き除外はされる想定。念のため空タイトルは除外）
const articles = (all || []).filter((a) => (a.title ?? "").toString().trim().length > 0);

// 日付ソート（date優先、なければpublishedAt）
articles.sort((a, b) => {
  const da = new Date((a.date || a.publishedAt || a.createdAt || 0) as any).getTime();
  const db = new Date((b.date || b.publishedAt || b.createdAt || 0) as any).getTime();
  return db - da;
});

// 最新
const latest = articles.slice(0, 8);

// カテゴリ集計（slugで重複排除、記事数も出す）
type CatAgg = { slug: string; label: string; count: number };
const catMap = new Map<string, CatAgg>();

for (const a of articles) {
  const cats = normalizeCategories((a as any).category);
  for (const c of cats) {
    const key = c.slug; // すでにencode済み想定
    const cur = catMap.get(key);
    if (cur) cur.count += 1;
    else catMap.set(key, { slug: key, label: c.label, count: 1 });
  }
}

// 件数が多い順（同数ならラベル順）
const categories = Array.from(catMap.values()).sort((x, y) => {
  if (y.count !== x.count) return y.count - x.count;
  return x.label.localeCompare(y.label, "ja");
}).slice(0, 8);
---
<BaseLayout
  title="SHIOLAB｜資格・受験・学習の攻略メディア"
  description="SHIOLABは、資格・受験・学校学習などの“4択試験攻略パターン”を、記事とクイズで学べる学習メディアです。"
>
  <!-- ヒーロー -->
  <section class="hero">
    <div class="heroInner">
      <div>
        <p class="kicker">4択試験の「選択肢を切る」技術</p>
        <h1>SHIOLAB</h1>
        <p class="lead">
          資格試験・受験・学校学習の4択問題を、<br />
          「なぜこの選択肢は切れるのか」という視点で整理した攻略メディアです。
        </p>

        <div class="heroActions">
          <a class="btn" href="/articles/">記事を読む</a>
          <a class="btn btn--ghost" href="https://quiz.shiolab.co.jp/" target="_blank" rel="noopener">
            クイズで練習
          </a>
        </div>
      </div>

      <div class="heroSide">
        <div class="heroBox">
          <h2 class="heroBoxTitle">まずはここから</h2>
          <ul class="heroList">
            <li>問題文より先に「形」を見る（主語・時制・品詞）</li>
            <li>切れる選択肢を先に消す（消去法を型にする）</li>
            <li>最後に意味を確認してミスを防ぐ</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- カテゴリ -->
  <section class="section">
    <div class="sectionHead">
      <h2 class="sectionTitle">カテゴリから探す</h2>
      <p class="sectionSub">今ある記事カテゴリを一覧で表示します。増えても破綻しない構成です。</p>
    </div>

    {categories.length === 0 ? (
      <section class="card">
        <p style="margin:0;">記事にカテゴリが付いていないため、カテゴリ一覧はまだ表示されません。</p>
      </section>
    ) : (
      <section class="grid grid--tight">
        {categories.map((c) => (
          <article class="card card--category">
            <h3 class="cardTitle" style="margin-bottom:6px;">{c.label}</h3>
            <p class="cardDesc" style="margin:0 0 12px;">
              {c.label} の攻略記事をまとめて表示します。
            </p>
            <a class="linkArrow" href={`/category/${c.slug}/`}>記事一覧を見る</a>
          </article>
        ))}
      </section>
    )}
  </section>

  <!-- 最新記事 -->
  <section class="section">
    <div class="sectionHead">
      <h2 class="sectionTitle">最新記事</h2>
      <p class="sectionSub">新しく追加された攻略パターンから読むと理解が早いです。</p>
    </div>

    {latest.length === 0 ? (
      <section class="card">
        <p style="margin:0;">まだ記事がありません。microCMSに記事を追加するとここに表示されます。</p>
      </section>
    ) : (
      <>
        <section class="grid">
          {latest.map((a) => (
            <ArticleCard item={a} />
          ))}
        </section>
        <p class="moreLink">
          <a href="/articles/">記事一覧へ →</a>
        </p>
      </>
    )}
  </section>
</BaseLayout>
