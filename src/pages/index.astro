---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategories } from "../lib/microcms";

const articles = await fetchAllArticles();

// 新しい順（date が無い場合は publishedAt / updatedAt を使う）
const toTime = (a: any) =>
  new Date(a.date || a.publishedAt || a.updatedAt || a.createdAt || 0).getTime();

articles.sort((a, b) => toTime(b) - toTime(a));

const latest = articles.slice(0, 8);

// カテゴリ一覧（slug -> label の重複排除）
const categoryMap = new Map<string, string>();
for (const a of articles) {
  for (const c of normalizeCategories(a.category)) {
    if (!categoryMap.has(c.slug)) categoryMap.set(c.slug, c.label);
  }
}
const categories = Array.from(categoryMap.entries()).map(([slug, label]) => ({ slug, label }));
---

<BaseLayout
  title="SHIOLAB｜資格・受験・学習の攻略メディア"
  description="SHIOLABは、資格試験・受験・学校学習などの“4択試験攻略パターン”を、記事と演習で学べる学習メディアです。"
>
  <section class="hero">
    <h1>SHIOLAB</h1>
    <p class="lead">
      4択問題の「選択肢の切り方」を、短い型として整理していきます。<br />
      勉強の内容そのものよりも、試験で点につながる「判断の型」を増やすことが目的です。
    </p>

    <div class="heroActions">
      <a class="btn primary" href="/articles/">記事を読む</a>
      <a class="btn" href="/quiz/">クイズへ（準備中）</a>
    </div>
  </section>

  <section class="sectionHead">
    <h2>最新記事</h2>
    <a class="smallLink" href="/articles/">一覧を見る →</a>
  </section>

  {latest.length === 0 ? (
    <section class="card">
      <p>まだ記事がありません。microCMS から記事を追加するとここに表示されます。</p>
    </section>
  ) : (
    <section class="grid">
      {latest.map((a) => {
        const cats = normalizeCategories(a.category);
        const date = (a.date || a.publishedAt || a.updatedAt || a.createdAt || "").toString();
        return (
          <article class="card">
            <h3 class="cardTitle">
              <a href={`/articles/${a.id}/`}>{a.title ?? "（無題）"}</a>
            </h3>

            {a.description ? <p class="cardDesc">{a.description}</p> : null}

            <div class="metaRow">
              {cats.length > 0 ? (
                <div class="tagRow">
                  {cats.map((c) => (
                    <a class="tag" href={`/category/${c.slug}/`}>{c.label}</a>
                  ))}
                </div>
              ) : (
                <span class="muted">カテゴリ未設定</span>
              )}

              {date ? <span class="muted">{date.slice(0, 10)}</span> : null}
            </div>
          </article>
        );
      })}
    </section>
  )}

  <section class="sectionHead" style="margin-top:34px;">
    <h2>カテゴリ</h2>
  </section>

  {categories.length === 0 ? (
    <section class="card">
      <p>カテゴリ付きの記事がまだありません。</p>
    </section>
  ) : (
    <section class="grid">
      {categories.map((c) => (
        <article class="card">
          <h3 class="cardTitle" style="margin-bottom:6px;">{c.label}</h3>
          <p class="cardDesc" style="margin-bottom:12px;">
            {c.label} の攻略パターンをまとめて見られます。
          </p>
          <a class="smallLink" href={`/category/${c.slug}/`}>カテゴリを見る →</a>
        </article>
      ))}
    </section>
  )}
</BaseLayout>
