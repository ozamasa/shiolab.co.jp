---
import BaseLayout from "../layouts/BaseLayout.astro";
import { microcms, type Article } from "../lib/microcms";

type CategoryLike =
  | string
  | { name?: string; title?: string }
  | Array<string | { name?: string; title?: string }>
  | null
  | undefined;

function normalizeCategories(cat: CategoryLike): string[] {
  if (!cat) return [];

  const toName = (x: any) => {
    if (!x) return "";
    if (typeof x === "string") return x.trim();
    if (typeof x === "object") return String(x.name ?? x.title ?? "").trim();
    return "";
  };

  if (Array.isArray(cat)) {
    return cat.map(toName).filter(Boolean);
  }
  const one = toName(cat);
  return one ? [one] : [];
}

let latest: Article[] = [];
let categoryCounts: Record<string, number> = {};
let errorMsg = "";

try {
  if (!microcms) throw new Error("microCMSの環境変数が未設定です");

  // 最新記事6件（表示用）
  const latestRes = await microcms.getList<Article>({
    endpoint: "articles",
    queries: {
      limit: 6,
      orders: "-publishedAt",
      fields: "id,title,description,category,publishedAt",
    },
  });
  latest = latestRes.contents ?? [];

  // カテゴリ一覧（集計用）：最新6件だけだと偏るので、最大100件拾う
  const catRes = await microcms.getList<{ category?: CategoryLike }>({
    endpoint: "articles",
    queries: {
      limit: 100,
      orders: "-publishedAt",
      fields: "category",
    },
  });

  categoryCounts = {};
  for (const item of catRes.contents ?? []) {
    for (const name of normalizeCategories(item.category)) {
      categoryCounts[name] = (categoryCounts[name] ?? 0) + 1;
    }
  }
} catch (e: any) {
  errorMsg = e?.message ?? String(e);
}

const categories = Object.entries(categoryCounts)
  .sort((a, b) => b[1] - a[1]) // 件数が多い順
  .map(([name]) => name);
---

<BaseLayout
  title="SHIOLAB｜学習を“解ける形”にする"
  description="SHIOLABは、試験や学習の“4択攻略パターン”を具体例つきで解説する学習メディアです。"
>
  <section class="card">
    <h1>SHIOLAB</h1>
    <p>
      SHIOLAB は、試験や学習でつまずきやすいポイントを「解ける形」に整理して、
      迷わず練習できるようにする学習メディアです。
    </p>
  </section>

  <h2 style="margin-top:32px;">最新記事</h2>

  {errorMsg ? (
    <section class="card">
      <p style="color:#b91c1c; margin:0;">記事の読み込みに失敗しました：{errorMsg}</p>
    </section>
  ) : latest.length === 0 ? (
    <section class="card">
      <p>まだ記事がありません。</p>
    </section>
  ) : (
    <section class="grid">
      {latest.map((a) => (
        <article class="card">
          <h3 style="margin:0 0 8px;">
            <a href={`/articles/${a.id}/`}>{a.title}</a>
          </h3>
          {a.description ? (
            <p style="font-size:14px; color:#666; margin:0;">{a.description}</p>
          ) : null}
        </article>
      ))}
    </section>
  )}

  <h2 style="margin-top:40px;">カテゴリ</h2>

  {categories.length === 0 ? (
    <section class="card">
      <p>カテゴリは記事の登録後に表示されます。</p>
    </section>
  ) : (
    <section class="grid">
      {categories.map((cat) => (
        <article class="card">
          <h3 style="margin:0 0 8px;">
            {cat} <span style="font-size:12px; color:#888;">({categoryCounts[cat]})</span>
          </h3>
          <p style="margin:0 0 10px;">{cat} の攻略パターンをまとめています。</p>
          <p style="margin:0;">
            <a href={`/category/${encodeURIComponent(cat)}/`}>一覧を見る →</a>
          </p>
        </article>
      ))}
    </section>
  )}
</BaseLayout>