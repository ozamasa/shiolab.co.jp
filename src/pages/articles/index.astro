---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategories } from "../../lib/microcms";

const articles = (await fetchAllArticles()).sort(
  (a, b) =>
    new Date(b.date || b.publishedAt || 0).getTime() -
    new Date(a.date || a.publishedAt || 0).getTime()
);
---

<BaseLayout
  title="記事一覧｜SHIOLAB"
  description="SHIOLABの記事一覧ページです。資格試験・受験対策に役立つ攻略パターンをまとめています。"
>
  <section class="card hero">
    <h1 style="margin:0 0 6px;">記事一覧</h1>
    <p style="margin:0;">攻略パターン記事を、新しい順に表示しています。</p>
  </section>

  {articles.length === 0 ? (
    <section class="card" style="margin-top:14px;">
      <p style="margin:0;">まだ記事がありません。</p>
    </section>
  ) : (
    <section class="grid three" style="margin-top:14px;">
      {articles.map((a) => {
        const cats = normalizeCategories(a.category);
        const dateText = String(a.date || a.publishedAt || a.createdAt || "").slice(0, 10);
        return (
          <article class="card">
            <h2 style="margin:0 0 10px; font-size:18px; line-height:1.35;">
              <a href={`/articles/${a.id}/`}>{a.title}</a>
            </h2>

            {a.description ? (
              <p style="font-size:14px; color:var(--muted); margin:0 0 12px;">
                {a.description}
              </p>
            ) : null}

            <div class="meta">
              {cats.length ? (
                <>
                  {cats.map((c) => (
                    <span class="pill">
                      <a href={`/category/${c.slug}/`}>{c.label}</a>
                    </span>
                  ))}
                </>
              ) : (
                <span style="color:var(--muted);">カテゴリ未設定</span>
              )}

              {dateText ? <span>更新：{dateText}</span> : null}
            </div>
          </article>
        );
      })}
    </section>
  )}
</BaseLayout>
