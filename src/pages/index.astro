---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchAllArticles, normalizeCategories } from "../lib/microcms";

const articles = await fetchAllArticles();

// 新しい順（date > publishedAt > createdAt）
articles.sort((a, b) => {
  const ad = new Date(a.date || a.publishedAt || a.createdAt || 0).getTime();
  const bd = new Date(b.date || b.publishedAt || b.createdAt || 0).getTime();
  return bd - ad;
});

const latest = articles.slice(0, 4);

// カテゴリ抽出（複数カテゴリ対応） + 件数
const catCount = new Map<string, { label: string; slug: string; count: number }>();

for (const a of articles) {
  const cats = normalizeCategories(a.category);
  for (const c of cats) {
    const prev = catCount.get(c.slug);
    if (!prev) catCount.set(c.slug, { ...c, count: 1 });
    else catCount.set(c.slug, { ...prev, count: prev.count + 1 });
  }
}

const categories = [...catCount.values()].sort((x, y) => y.count - x.count).slice(0, 8);
---

<BaseLayout
  title="SHIOLAB｜4択試験の攻略パターン集"
  description="資格試験・受験・学校学習の4択問題を、「なぜこの選択肢は切れるのか」の視点で整理した学習メディア。"
>
  <section class="hero">
    <div class="heroInner">
      <p class="kicker">4択試験の「切り方」を学ぶ</p>
      <h1 class="heroTitle">SHIOLAB</h1>
      <p class="heroLead">
        資格試験・受験・学校学習の4択問題を、
        「なぜこの選択肢は切れるのか」の視点で整理した学習メディアです。
      </p>

      <div class="heroActions">
        <a class="btn" href="/articles/">攻略パターンを読む</a>
        <a class="btn sub" href="https://quiz.shiolab.co.jp/" target="_blank" rel="noopener">
          クイズで確認する
        </a>
      </div>
    </div>
  </section>

  <section class="sectionHeader">
    <h2>カテゴリから探す</h2>
    <p>今ある記事を、分野ごとにまとめています。</p>
  </section>

  {categories.length === 0 ? (
    <section class="card">
      <p class="muted" style="margin:0;">
        まだカテゴリがありません。記事にカテゴリを設定すると、ここに表示されます。
      </p>
    </section>
  ) : (
    <section class="grid">
      {categories.map((c) => (
        <a class="card cardHover catCard" href={`/category/${c.slug}/`}>
          <div class="catTop">
            <h3 class="catTitle">{c.label}</h3>
            <span class="pill">{c.count}件</span>
          </div>
          <p class="catDesc">このカテゴリの記事を見る</p>
        </a>
      ))}
    </section>
  )}

  <div class="splitRow">
    <section style="min-width:0;">
      <div class="sectionHeader" style="margin-top:0;">
        <h2>最新記事</h2>
        <p>最近追加された攻略パターン</p>
      </div>

      {latest.length === 0 ? (
        <section class="card">
          <p class="muted" style="margin:0;">まだ記事がありません。</p>
        </section>
      ) : (
        <section class="stack">
          {latest.map((article) => {
            const cats = normalizeCategories(article.category);
            const dateText = (article.date || article.publishedAt || article.createdAt || "").toString();
            return (
              <article class="card cardHover">
                <div class="cardRow">
                  <div style="min-width:0;">
                    <h3 class="cardTitle" style="margin:0 0 6px;">
                      <a href={`/articles/${article.id}/`}>{article.title}</a>
                    </h3>

                    {article.description ? (
                      <p class="cardDesc" style="margin:0 0 10px;">
                        {article.description}
                      </p>
                    ) : null}

                    <div class="cardMeta">
                      {cats.length > 0 ? (
                        <div class="metaTags">
                          {cats.slice(0, 2).map((c) => (
                            <a class="tag" href={`/category/${c.slug}/`}>{c.label}</a>
                          ))}
                        </div>
                      ) : (
                        <div class="metaTags"><span class="tag muted">カテゴリ未設定</span></div>
                      )}
                      {dateText ? <span class="metaDate">{dateText.slice(0, 10)}</span> : null}
                    </div>
                  </div>
</div>
        <div class="cardActions">
          <a class="btnLink btnPrimary" href={`/articles/${a.id}/`}>続きを読む</a>
        </div>
      </article>
            );
          })}
        </section>
      )}

      <div style="margin-top:14px;">
        <a class="btn sub" href="/articles/">記事一覧へ</a>
      </div>
    </section>

    <aside class="sideCard">
      <h3 style="margin:0 0 8px;">使い方</h3>
      <ol class="steps">
        <li>カテゴリから、近いテーマを選ぶ</li>
        <li>「切れる理由」を読んで、型を覚える</li>
        <li>クイズで確認して、定着させる</li>
      </ol>
      <a class="btn" style="margin-top:10px;" href="/guide/">使い方を見る</a>
    </aside>
  </div>
</BaseLayout>
